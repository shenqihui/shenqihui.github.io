<!DOCTYPE html><html lang="zh-cmn-Hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><title>javascript 函数劫持 | 大饼</title><meta name="author" content="大饼"><meta name="description" content="博客,blog,前端,hexo,nodejs,javascript,python,html,css,npm"><link rel="alternate" href="/atom.xml" title="大饼" type="application/rss2.xml"><meta name="description" content="最近在搞坏事，因此总会有一些很猥琐很猥琐的想法。具体有多少，只有你想不到，没有做不到。这里就来讲讲如何在 js 层面，神不知鬼不觉的劫持函数。"><meta name="keywords" content="javascript,技术,前端"><meta property="og:type" content="article"><meta property="og:title" content="javascript 函数劫持"><meta property="og:url" content="http://blog.shenqh.com/2015/02/12/the-Italian-job-hijacked-the-javascript-function/index.html"><meta property="og:site_name" content="大饼"><meta property="og:description" content="最近在搞坏事，因此总会有一些很猥琐很猥琐的想法。具体有多少，只有你想不到，没有做不到。这里就来讲讲如何在 js 层面，神不知鬼不觉的劫持函数。"><meta property="og:locale" content="zh-cmn-Hans"><meta property="og:updated_time" content="2016-12-02T16:08:39.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="javascript 函数劫持"><meta name="twitter:description" content="最近在搞坏事，因此总会有一些很猥琐很猥琐的想法。具体有多少，只有你想不到，没有做不到。这里就来讲讲如何在 js 层面，神不知鬼不觉的劫持函数。"><meta name="twitter:creator" content="@shenqihui"><link rel="alternative" href="/atom.xml" title="大饼" type="application/atom+xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/app.css"><style type="text/css">body,h1,h2,h3,h4,h5,h6{font-family:Raleway,sans-serif}</style><style type="text/css">code,kbd,pre,samp,tt,var{font-family:Monaco,Consolas,monospace}</style></head></html><body class="site-page"><nav class="site-navbar"><ul nav-left><h1>大饼</h1></ul><ul nav-right><li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li><li><a href="/link">Link</a></li><li><a href="http://www.weibo.com/p/1005051896403155" target="_blank">Weibo</a></li><li><a href="https://github.com/shenqihui" target="_blank">Github</a></li><li><a href="/about">About</a></li></ul></nav><section site-body part-post><section post><article id="post-the-Italian-job-hijacked-the-javascript-function" layout="post"><h1 post-title>javascript 函数劫持</h1><time post-time datetime="2015-02-11T16:38:04.000Z" itemprop="datePublished">2015 年 02 月 12 日</time><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端/">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术/">技术</a></li></ul><div class="clearfix"></div><div page-excerpt><p>最近在搞坏事，因此总会有一些很猥琐很猥琐的想法。<br>具体有多少，只有你想不到，没有做不到。<br>这里就来讲讲如何在 js 层面，神不知鬼不觉的劫持函数。</p></div><div page-more><h2 id="函数劫持是什么？"><a href="#函数劫持是什么？" class="headerlink" title="函数劫持是什么？"></a>函数劫持是什么？</h2><p>这里所说的函数劫持，是在不改变原有功能的前提下，注入自己想要的功能。<br>改变原有功能的劫持方式简单粗暴，这里不推荐这种想法。<br>我们要做的，就是天知地知你知我知其他人不知。</p><h2 id="函数劫持能干什么？"><a href="#函数劫持能干什么？" class="headerlink" title="函数劫持能干什么？"></a>函数劫持能干什么？</h2><p>首先你得明白为什么要劫持。<br>一旦你明白了为什么要劫持，就需要找劫持点，进行函数重写劫持。<br>具体在这个重写之后的函数增加什么功能，就看你为什么要劫持了。<br>函数劫持了，你想干什么，就能干什么。</p><h2 id="劫持的原理"><a href="#劫持的原理" class="headerlink" title="劫持的原理"></a>劫持的原理</h2><p>一般的劫持原理都是一个思路：<br>一、使用新的变量保存即将被劫持的函数。<br>二、改写被劫持函数的功能。<br>三、在被劫持函数的末尾段（或者其他适当部位）重新调用重写之前的函数。</p><h2 id="如何进行劫持"><a href="#如何进行劫持" class="headerlink" title="如何进行劫持"></a>如何进行劫持</h2><p>先来看看下面这段代码。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save old ajax</span></span><br><span class="line">$._ajax = $.ajax;</span><br><span class="line"><span class="comment">// incase something.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noop</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// 我想要加入的功能</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunctionToHack</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data);</span><br><span class="line">  <span class="comment">// do something you want</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// accord $.ajax to change</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxHacker</span>(<span class="params">e, n</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// old success function</span></span><br><span class="line">  e._success = e.success || noop;</span><br><span class="line">  <span class="comment">// new success function of lucky money</span></span><br><span class="line">  e.success = <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    myFunctionToHack(data);</span><br><span class="line"></span><br><span class="line">    e._success.call(<span class="keyword">this</span>, data);</span><br><span class="line">    </span><br><span class="line">  &#125;;</span><br><span class="line">  $._ajax(e, n);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// change default ajax</span></span><br><span class="line">$.ajax = ajaxHacker;</span><br></pre></td></tr></table></figure><p>这段代码的作用估计大家都一目了然。<br>主要的功能就是重写 jquery 的 ajax 请求函数，在原生的 ajax 功能的基础上，劫持 success 回调功能。</p><p>具体劫持方式：</p><h3 id="使用新的变量保存即将被劫持的函数"><a href="#使用新的变量保存即将被劫持的函数" class="headerlink" title="使用新的变量保存即将被劫持的函数"></a>使用新的变量保存即将被劫持的函数</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$._ajax = $.ajax;  </span><br><span class="line">e._success = e.success || noop;</span><br></pre></td></tr></table></figure><p>保存旧方法方便调用。</p><h3 id="改写被劫持函数的功能"><a href="#改写被劫持函数的功能" class="headerlink" title="改写被劫持函数的功能"></a>改写被劫持函数的功能</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$.ajax = ajaxHacker;</span><br><span class="line">e.success = <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把 <code>jquery</code> 的 <code>ajax</code> 替换为 <code>ajaxHacker</code> 函数，实现就功能的改写。</p><h3 id="在被劫持函数的末尾段重新调用重写之前的函数"><a href="#在被劫持函数的末尾段重新调用重写之前的函数" class="headerlink" title="在被劫持函数的末尾段重新调用重写之前的函数"></a>在被劫持函数的末尾段重新调用重写之前的函数</h3><p>为了保持功能与原来的基本一致，需要重新调用原来的函数。<br>一般情况下面都是在处理完毕自己想要的功能之后调用。这些都看个人习惯进行。<br>由于上面的代码有两个函数劫持，所以分开来讲：</p><p>先看一个简单的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajaxHacker</span>(<span class="params">e, n</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  $._ajax(e, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个时候，旧的 <code>jquery</code> <code>ajax</code> 功能就能在 <code>ajaxHacker</code> 执行末尾调用，<br>中途就能增加自己想要的功能了。</p><p>复杂点的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">e.success = <span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  myFunctionToHack(data);</span><br><span class="line"></span><br><span class="line">  e._success.call(<span class="keyword">this</span>, data);</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>success</code> 回调函数保存在 <code>e._success</code> 里面，重写了 <code>success</code> 功能之后，重新调用 <code>e._success</code>。<br>但是这个时候使用了 <code>call</code> 进行调用，原因就是避免函数运行环境 <code>this</code> 对象变化了。使用 <code>call</code> 能够确保劫持之前的运行上下文与劫持之后的运行上下文一致。<br>当然如果 <code>this</code> 对象没被使用的话，不使用 <code>call</code> 也是可以的，</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e._success(data);</span><br></pre></td></tr></table></figure><p>这样子调用，也行。</p><p>另外也可以使用 <code>apply</code> 代替 <code>call</code> ，两者都能操控 <code>this</code> 。</p><p>PS: 第二个例子，不使用 <code>call</code> 其 <code>this</code> 对象也是 <code>e</code>。因为使用了命名空间的方式进行了调用。如果不是使用 <code>e._success</code> 而是使用 <code>_success</code> 保存就函数，就必须使用 <code>call</code> 或者 <code>apply</code> 来确保运行上下文正确。</p></div><nav class="pagination"><a post-prev href="/2015/08/14/test_django_post_request_method/" title="Django 框架关于 IE 跨域 XDomainRequest 传输的问题">&#10094; Django 框架关于 IE 跨域 XDomainRequest 传输的问题</a> <a post-next href="/2015/01/29/best-practices-of-git/" title="Git 最佳实践">Git 最佳实践 &#10095;</a></nav></article><section id="comments"><div id="disqus_thread"></div></section></section></section><section site-body class="dn"><nav><a href="/tags/css/" style="font-size:12px;color:#636363">css</a> <a href="/tags/ellipsis/" style="font-size:10px;color:#777">ellipsis</a> <a href="/tags/git/" style="font-size:10px;color:#777">git</a> <a href="/tags/javascript/" style="font-size:16px;color:#3a3a3a">javascript</a> <a href="/tags/life/" style="font-size:10px;color:#777">life</a> <a href="/tags/ppt/" style="font-size:10px;color:#777">ppt</a> <a href="/tags/python/" style="font-size:10px;color:#777">python</a> <a href="/tags/table/" style="font-size:10px;color:#777">table</a> <a href="/tags/warp/" style="font-size:10px;color:#777">warp</a> <a href="/tags/前端/" style="font-size:18px;color:#252525">前端</a> <a href="/tags/技术/" style="font-size:20px;color:#111">技术</a> <a href="/tags/旅游/" style="font-size:14px;color:#4e4e4e">旅游</a> <a href="/tags/生活/" style="font-size:10px;color:#777">生活</a> <a href="/tags/设计/" style="font-size:10px;color:#777">设计</a></nav></section><footer site-footer><div copyright>&copy; 2018 大饼<h4>吾十有五而志于养猪，三十始养，四十亏本，五十再亏，六十亏大了，七十卒，不逾矩。现廿五，将卒。</h4></div><div powered><b>Hexo <a href="https://github.com/shenqihui/hexo-theme-pithy" target="_blank">Pithy</a></b> Theme designed by <b><a href="http://blog.shenqh.com/" target="_blank">shenqihui</a></b>, Powered by <b><a href="http://hexo.io/" target="_blank">Hexo</a></b> and <b><a href="https://pages.github.com/">Github Pages</a></b>. <b><a href="/sitemap.xml">Sitemap</a></b>. <b><a href="/atom.xml">Rss</a></b>.</div><br><div footer_word>我们俩都是年轻人，要将自己献身于伟大事业的开创，我们是天生的魔术师，但我们不会用自己的天赋去伤害任何人。 -- 阿尔弗雷德·波登 《致命魔术》</div></footer><script>setTimeout(function(){var e="shenqihuiblog";!function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="//"+e+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(t)}()},100)</script><script type="text/javascript">!function(e,a,t,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=a.createElement(t),o=a.getElementsByTagName(t)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-48454013-1","auto"),ga("require","displayfeatures"),ga("send","pageview")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?a359010dd82707c1ee6d1ca5d64be33b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></body>