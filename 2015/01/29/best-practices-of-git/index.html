<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="utf-8">
  
  <title>Git 最佳实践 | 神奇辉</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="今天一个朋友在他们的 git 工作流上面遇到问题了。来询问我关于我们团队是如何使用 git 进行团队协作的。 然后我就秉着技术分享的思想给他们讲解。特意写下此文。git 这东西，用得好就是好东西。用得不好，那就只能怪你没下功夫去用了。骚年，勇敢的用起来吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="Git 最佳实践">
<meta property="og:url" content="http://shenqihui.github.io/2015/01/29/best-practices-of-git/index.html">
<meta property="og:site_name" content="神奇辉">
<meta property="og:description" content="今天一个朋友在他们的 git 工作流上面遇到问题了。来询问我关于我们团队是如何使用 git 进行团队协作的。 然后我就秉着技术分享的思想给他们讲解。特意写下此文。git 这东西，用得好就是好东西。用得不好，那就只能怪你没下功夫去用了。骚年，勇敢的用起来吧。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Git 最佳实践">
<meta name="twitter:description" content="今天一个朋友在他们的 git 工作流上面遇到问题了。来询问我关于我们团队是如何使用 git 进行团队协作的。 然后我就秉着技术分享的思想给他们讲解。特意写下此文。git 这东西，用得好就是好东西。用得不好，那就只能怪你没下功夫去用了。骚年，勇敢的用起来吧。">
<meta name="twitter:creator" content="@shenqihui">
  
    <link rel="alternative" href="/atom.xml" title="神奇辉" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div id="wrap">
      <header class="header">
  <div class="header-outer outer">
    <div class="profile_img">
      <img class="circle_img" src="/img/profile_img.jpg" />
    </div>
    <div class="header-title">
      <h1 class="logo">神奇辉</h1>
      
        <h4 class="subtitle">吾十有五而志于养猪，三十始养，四十亏本，五十再亏，六十亏大了，七十卒，不逾矩。现廿五，将卒。</h4>
      
    </div>
    <div class="header-menu">
      <nav class="main-nav">
        <ul>
        
          <li><a href="/"><i class="fa fa-home icon-setting"></i></a></li>
        
          <li><a href="http://www.weibo.com/p/1005051896403155"><i class="fa fa-weibo icon-setting"></i></a></li>
        
          <li><a href="https://github.com/shenqihui"><i class="fa fa-github icon-setting"></i></a></li>
        
          <li><a href="mailto:c2hlbnFpaHVpMDkyMEBnbWFpbC5jb20K"><i class="fa fa-envelope-o icon-setting"></i></a></li>
        
        
          <li><a href="/atom.xml"><i class="fa fa-rss %> icon-setting"></i></a></li>
        
        </ul>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-best-practices-of-git" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/01/29/best-practices-of-git/" class="article-date">
  <time datetime="2015-01-29T15:11:00.000Z" itemprop="datePublished">2015 年 01 月 29 日</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Git 最佳实践
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天一个朋友在他们的 git 工作流上面遇到问题了。来询问我关于我们团队是如何使用 git 进行团队协作的。 然后我就秉着技术分享的思想给他们讲解。特意写下此文。git 这东西，用得好就是好东西。用得不好，那就只能怪你没下功夫去用了。骚年，勇敢的用起来吧。  </p>
<a id="more"></a>
<h2 id="前言">前言</h2><p>怎么使用 git， 为啥使用 git， 如何使用 git， git 和 svn 或者 hg 哪个好，就不说了，个人还是觉得 git 好。如果你觉得意见不同，来打我啊。<br>本文提到的项目是网站类型的，迭代比较快，所以一旦有功能完成就即刻发布。  </p>
<h2 id="我们的使用场景">我们的使用场景</h2><p>项目是一个网站，开发团队 n(n&gt;3)人。使用的时内部的 git 仓库。  </p>
<h2 id="仓库规范">仓库规范</h2><p>项目发起由项目组组织（organization）发起，每个项目成员进行仓库的 fork 操作，不允许 push 代码至非自己所有的远程仓库。  </p>
<h2 id="分支规范">分支规范</h2><p>每个人都进行了仓库的 fork 操作，因此每个人的仓库（下称 origin ）分支就自由发挥了。主要讲讲主仓库（下称 upstream ）的分支规范。<br>主仓库主要存在两个分支，master + dev 分支，具体名字可以随便，能理解就好。</p>
<h3 id="dev_分支的功能">dev 分支的功能</h3><p>dev 有两个功能，一个是发布到测试环境进行新功能测试，另外一个是用于团队成员进行 mr 时候使用的分支，最新功能一旦开发测试完毕，就进行 origin/branchname mr 到 upstream/dev 的操作， 分配给其他项目成员进行 review 。<br>mr 期间成员可以任意对代码进行审查评论，mr 发起人需要对评论进行回应。  </p>
<h3 id="master_分支的功能">master 分支的功能</h3><p>master 是生产环境所使用的代码，因此得确保 master 分支的代码时刻可用。如何确保，就是确保 dev 的代码能够无已知 bug 地运行了，才进行 upstream/dev mr upstream/master 的操作。dev 一旦新功能测试成功，就提 mr 至 master 分支， 分配给自己。然后自己点击 accept mr 的操作。<br>这一步操作，看似多余，但是能确保 master 分支时刻可用。</p>
<h2 id="mr_的规范">mr 的规范</h2><p>上面讲完了两个分支的作用，这是大部分仓库基本上的操作，估计很多人都清楚。<br>那如何是用这两个分支进行方便团队协作呢？这个就是一门学问了。<br>由于前面提到了， dev 和 master 只能通过 mr 方法进行代码的变动，所以，提交 mr 的时候就需要确保该 mr 能够让 git 仓库程序自动 accept（自动 accept 的意思是点击 accept 按钮就能合并代码），其他成员确定 mr accept 时候，只需点击按钮即可完成，而不是 merge this request manually 。</p>
<h2 id="团队协作踩坑大法">团队协作踩坑大法</h2><p>说一个场景很容易遇到的场景，假设项目 A 同时有 B 、 C 两个功能同时开发。不久， B 、 C 同时提了个 mr 上来。然后， B 经过 review 目测无 bug，点击了 accept ， 然后 C 也经过了 review 目测无 bug，点击了 accept 。<br>但是目测失败了，线上生产环境是非常复杂，一堆的机器、分布式数据库，超大数据量等等，造成 B 功能在模拟环境运行失败的情形。然而此时 C 功能目测无 bug 测试也无 bug ，可发布生产环境了。但是由于 B 功能出现 bug ，dev 此时就不能进行 mr 到 master 进行功能发布了。<br>C 功能急着发布，也只能看着 B 功能的成员修复此 bug 了。或者先把 B 功能从 dev 慢慢抠出来发布。但是这个是坑。</p>
<p>这里的漏洞就是 B 、 C 功能在 mr 阶段没有进行模拟生产环境测试就直接 accept 造成的。所以，就得解决这个问题。只有通过了 mr 阶段的模拟生产环境测试的 mr 才能点击 accept 进行代码合并。</p>
<h2 id="如何解决_mr_阶段测试的问题">如何解决 mr 阶段测试的问题</h2><p>说说项目的测试环境，<br>1、 用于 dev 分支代码的测试，基本上和生产环境一致，只是运行的代码不同而已。<br>2、 用于测试 mr 的测试环境，mr 测试的功能由自己控制，随便部署，每个提交 mr 的所有者需要部署 mr 环境给其他 review 代码的成员进行测试使用。在确保代码质量的同时，也确保了由于开发环境跟生产环境差异造成的代码缺陷。</p>
<h2 id="团队协助规范">团队协助规范</h2><ol>
<li>禁止 push 代码至非 origin 仓库  </li>
<li>使用 fetch + rebase 代替 pull + merge 更新其他成员最新的代码，不予许使用 pull + merge  </li>
<li>upstream 只能通过 mr 方式进行代码合并请求  </li>
<li>功能 mr 必须 asign 给非自己进行代码审查  </li>
</ol>
<hr>
<p>我要开始讲故事了</p>
<hr>
<h2 id="如何进行团队的协助">如何进行团队的协助</h2><p>以场景进行讲解吧。</p>
<h3 id="需求订立">需求订立</h3><p>开发的功能都商量好了，产品狗可以一边玩去。项目起了个响当当的名字，叫做古猫搜索引擎，小明（git id ming） 和 小花（git id hua，女的打字工哦） 再加几个打酱油的打字工进行开发。</p>
<h3 id="创建仓库">创建仓库</h3><p>他们创建了个组织叫古猫组织（git id goocat），然后创建了个 goocat 仓库，设置主分支为 dev ，master 留着暂时不管，push 个 相同的 init 到 dev 和 master ，然后把小明和小花还有几个打酱油的设置为管理员权限。仓库就这样子弄上来了。 .gitignore 、 WTFPL 什么的，也在这个时候加上去。  </p>
<h3 id="打字工出场">打字工出场</h3><p>这个时候，产品狗的什么，已经为了避免冲突，被送去某个小黑屋好好呆着了。<br>其他打酱油的被分配开发数据库什么的了。<br>小明和小花就马上动手写代码开发 index 页面，自己动手，丰衣足食。马上 fork 仓库， git clone 、 git remote add 什么一气呵成， add 了 upstream 和其他项目组成员的仓库地址。<br>小明用上了打 dota 的 apm ，瞬间把后台功能完成了， push origin api 完成，接下来等妹子小花来补充前端开发了。小花真羡慕打 dota 的人的 apm 能这么高，用来写代码瞬间就写完了。<br>但是小明完成的功能只是整个功能的一半，需要小花继续进行，所以小花第一步就是更新小明的代码下来<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git remote -v </span><br><span class="line">git remote add ming git@**<span class="class">.com</span>:ming/goocat<span class="class">.git</span></span><br><span class="line">git fetch ming </span><br><span class="line">git checkout -<span class="tag">b</span> page </span><br><span class="line">git rebase -<span class="tag">i</span> ming/api</span><br></pre></td></tr></table></figure></p>
<p>然后根据提示把 rebase 进行到底。这样子就能获取小明最新的代码了。</p>
<p>小花技术也杠杠的，瞬间接上了小明的几个 api。</p>
<h3 id="需求变动">需求变动</h3><p>到了某个 api 的时候，发现页面展示效果其实没那么好，这个时候召唤产品狗和小明过来。</p>
<p>他们间对话</p>
<blockquote>
<p>小花：这个功能我要这样这样这样，这样才是最好的交互效果。<br>小明这个时候使劲点头，手里的也不停下，拿着犀牛书在看。也能够在跟产品狗起争执时候一书拍过去，屡试不爽好吗，那个产品狗都被吓怕了。<br>产品狗看了下小明的犀牛书，擦了下汗：这个想法非常好，就这么实现了</p>
</blockquote>
<p>就这样子，没啥废话，需求就这样变吧。</p>
<h3 id="多人协作">多人协作</h3><p>需求变动了，api 继续变下，小花女神交代小明改改api，我的分支是 apge ，小明刷刷刷几下就马上动手改了。</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">git checkout api</span><br><span class="line">git status</span><br><span class="line">git remote -v</span><br><span class="line">git remote add nvshen git<span class="comment">@**.com:hua/goocat.git</span></span><br><span class="line">git fetch nvshen</span><br><span class="line">git stash</span><br><span class="line">git rebase -i nvshen/page</span><br><span class="line"><span class="comment"># 坐等 git rebase 完成</span></span><br><span class="line">git stash pop</span><br><span class="line">vim <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.py</span><br><span class="line">vim api.md</span><br><span class="line"><span class="comment"># 编辑完毕代码</span></span><br><span class="line">git add <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>.py api.md</span><br><span class="line">git commit -m '根据女神说的需求改动，进行 古猫搜索部分 api 改动'</span><br><span class="line">git push origin api</span><br></pre></td></tr></table></figure>
<p>然后跑过女神那里说： 小花，改动完了，你 fetch 下来看看呗。<br>小花有开始了这个功能代码的编写，获取小明最新的代码：<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git stash </span><br><span class="line">git fetch ming</span><br><span class="line">git <span class="keyword">push</span> origin page</span><br><span class="line">git rebase -i ming/api</span><br><span class="line">git stash <span class="keyword">pop</span></span><br></pre></td></tr></table></figure></p>
<p>然后继续进行代码的开发，编写完毕果断使用 github 客户端进行代码的 commit，不错不错，功能 done 。提交仓库给小明吧。<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">push</span> origin page</span><br><span class="line"><span class="preprocessor"># 打印了一堆的冲突的信息</span></span><br><span class="line">git <span class="keyword">push</span> -f origin page</span><br></pre></td></tr></table></figure></p>
<p>然后到线上仓库看看时候提交成功了，看看 commit ，看到了之前小明的 commit </p>
<blockquote>
<p>‘根据女神说的需求改动，进行 古猫搜索部分 api 改动’</p>
</blockquote>
<p>然后小花又叹气了</p>
<blockquote>
<p>这小明，老是这样子，一点勇气都没有。</p>
</blockquote>
<p>然后在微信朋友圈发了条 Text ： 你主动一点，我们之间就会有故事。<br>然后告知小明前端开发完毕了，提 mr 测试吧。</p>
<h3 id="mr_操作">mr 操作</h3><p>这个时候小明就开始提 mr 了<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git fetch nvshen</span><br><span class="line">git <span class="keyword">push</span> origin api</span><br><span class="line">git rebase -i nvshen/page</span><br><span class="line">git <span class="keyword">push</span> -f origin api</span><br></pre></td></tr></table></figure></p>
<p>上仓库进行 mr 了，提交了个 mr ，指向给了某一个打酱油的打字工 A 进行 review ，看到写着不能自动 accept，原来其他几个打酱油的已经把部分功能提交并且 accept 了，而且代码有冲突，这个时候小明就要做成没冲突了。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch upstream</span><br><span class="line">git rebase -<span class="tag">i</span> upstream/dev</span><br><span class="line">git push -f origin api</span><br></pre></td></tr></table></figure></p>
<p>回 upstream 仓库看看，不错，能自动 accept 了。</p>
<h3 id="review_&amp;&amp;_accept">review &amp;&amp; accept</h3><p>打酱油 A 提了部分意见，小明都一一做了改动。最后 mr 环境测试成功了， accept ，发布到 dev 环境， 也成功，上线，古猫搜索引擎 demo 版本出来了。<br>v0.1.0 实现了。</p>
<h3 id="打版本了">打版本了</h3><p>产品狗一阵激动，终于实现了小部分了。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone git@**<span class="class">.com</span>:goocat:goocat<span class="class">.git</span></span><br><span class="line">git checkout dev</span><br><span class="line">git tag v0.<span class="number">1.0</span></span><br><span class="line">git push origin --tag</span><br></pre></td></tr></table></figure></p>
<p>奔走相告，今晚大家唱歌庆祝。白天鹅 KTV 唱 K。</p>
<h3 id="庆功会">庆功会</h3><p>小花点了一首歌： she 的 《恋人未满》，申请的唱出来了，眼睛还冒着泪花，时不时还望了望小明。</p>
<p>故事唱完了，小花很伤心：</p>
<blockquote>
<p>那小明怎么能这样子，一点都不主动。  </p>
</blockquote>
<p>然后喝了很多酒。结果醉了，领导说：</p>
<blockquote>
<p>小明，公司里面你和小花关系最好了，今晚你负责送她回家啦。  </p>
</blockquote>
<p>小明呆呆的望着女神去了。</p>
<p>散场了，小明扶着小花上了出租车，送小花回家，然后就没有然后了。<br>这是个悲伤的故事。</p>
<hr>
<p>故事讲完了，大家洗洗睡吧。</p>
<hr>
<h2 id="科普下上面提到的名词">科普下上面提到的名词</h2><p>upstream : 上层仓库<br>origin : 当前所有者的仓库<br>master : 生产代码主分支<br>dev : 开发代码主分支<br>merge : 合并代码<br>mr : merge request, 合并代码请求<br>accept : 接受代码合并请求<br>review : 队友对你的代码进行审查<br>bug : 八阿哥<br><del>以下的词我解析不了，有很多东西中文是没法解析的，自己理解</del><br>git : 词典释义为饭桶，无用的人 →_→<br>organization : 相对于成员，它就是组织<br>fork : 词典释义为叉子<br>clone : 克隆</p>
<h2 id="彩蛋">彩蛋</h2><p>看到这里，也挺艰难的，其实 dev 测试环境可以去掉不用。<br>至于其他的不同的方法，欢迎评论指导。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://shenqihui.github.io/2015/01/29/best-practices-of-git/" data-id="cihzxm6oc001gviazkuq83wy4" class="article-share-link">Share</a>
      
        <a href="http://shenqihui.github.io/2015/01/29/best-practices-of-git/#disqus_thread" class="article-comment-link">Comments</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/02/12/the-Italian-job-hijacked-the-javascript-function/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          javascript 函数劫持
        
      </div>
    </a>
  
  
    <a href="/2015/01/17/XSRF/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">XSRF测试题</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 神奇辉<br>
      Theme remake by <a href="https://github.com/shenqihui/hexo-theme-alberta" target="_blank">shenqihui</a> base <a href="http://jaychung.tw" target="_blank">jaychung</a>'s <a href="https://github.com/ken8203/hexo-theme-alberta" target="_blank">Alberta</a>. Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://pages.github.com/">Github Pages</a>. <a href="/sitemap.xml">Sitemap</a> .
      
        <br>
        <br>
        “我们俩都是年轻人，要将自己献身于伟大事业的开创，我们是天生的魔术师，但我们不会用自己的天赋去伤害任何人。” -- 阿尔弗雷德·波登 《致命魔术》
      
    </div>
  </div>
</footer>

    </div>
    
    
<script>
  var disqus_shortname = 'shenqihuiblog';
  
  var disqus_url = 'http://shenqihui.github.io/2015/01/29/best-practices-of-git/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js
"></script>
<!--<script src="//imsky.github.io/holder/holder.js"></script>-->

  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>
<script src="http://t.cn/RLoNqCM"></script>
  </div>
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-48454013-1', 'auto');
ga('require', 'displayfeatures');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<!-- Baidu Analytics -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?a359010dd82707c1ee6d1ca5d64be33b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- Baidu Google Analytics -->

</body>
</html>